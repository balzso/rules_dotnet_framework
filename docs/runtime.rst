.. _runtime:

Runtime considerations
======================

.. note::
   This documentation is adapted from the original `rules_dotnet <https://github.com/bazelbuild/rules_dotnet>`_ project (commit d672bdb).
   This fork focuses exclusively on .NET Framework 4.7-4.7.2 support on Windows.

Runtime setup
-------------

Bazel rules maintain the list of files required to run a given executable. When the run
is requested (via ``bazel run`` or ``bazel test``), a manifest file is generated by Bazel.
rules_dotnet_framework uses this file to link all runtime files in the same directory as the
executable to run.

.NET Framework
--------------

.NET Framework uses the `Global Assembly Cache (GAC) <https://docs.microsoft.com/en-us/dotnet/framework/app-domains/gac>`_.
Therefore, the runtime .NET Framework dependencies linked by rules_dotnet_framework are
not used if the assembly exists in the GAC. This may lead to unexpected behavior, particularly
when using NuGet packages.

Key considerations:

**GAC Priority**: Assemblies in the GAC take precedence over local copies. This means if you have
a specific version of a NuGet package dependency, but a different version exists in the GAC,
the GAC version will be loaded at runtime.

**Framework Installation**: .NET Framework 4.7+ must be installed on the Windows system.
The Framework is typically pre-installed on Windows 10+, but you may need to install it
on Windows Server or older systems.

**Reference Assemblies**: At build time, the rules use Reference Assemblies from the
Windows SDK, not the runtime assemblies from ``C:\Windows\Microsoft.NET\Framework``.
Reference assemblies provide the API surface but don't contain implementation.

**Windows-specific Paths**: All paths are Windows-specific (e.g., ``C:\Program Files (x86)\Reference Assemblies\...``).
This ruleset does not support cross-platform builds.

**Long Paths**: Bazel creates deep directory structures. You may need to enable long path support
in Windows 10+:

.. code:: registry

    HKLM\SYSTEM\CurrentControlSet\Control\FileSystem\LongPathsEnabled = 1

Alternatively, set ``TMP`` and ``TEMP`` environment variables to short paths:

.. code:: batch

    set TMP=C:\TEMP
    set TEMP=C:\TEMP

VSTO Runtime Considerations
----------------------------

For VSTO (Visual Studio Tools for Office) add-ins, additional runtime requirements apply:

**VSTO Runtime**: The Visual Studio 2010 Tools for Office Runtime must be installed on
end-user machines. This is typically bundled with Visual Studio or Office installations.

Download: `VSTO Runtime <https://www.microsoft.com/en-us/download/details.aspx?id=56961>`_

**Office Installation**: The target Office application (Excel, Word, Outlook, PowerPoint) must
be installed on the machine.

**ClickOnce Manifests**: VSTO add-ins use ClickOnce deployment manifests (.manifest and .vsto files).
These manifests must be signed with an Authenticode certificate for production deployments.

**Trust Settings**: Users may need to trust the certificate or add the deployment location to
the Trusted Locations list in Office.

See ``docs/vsto.md`` for detailed VSTO development and deployment guide.

Native Dependencies
-------------------

Some NuGet packages include native (unmanaged) DLLs. These must be copied to the output directory
alongside the managed assemblies.

The ``nuget_package`` rule supports the ``net_files`` attribute to specify additional runtime files:

.. code:: python

    nuget_package(
        name = "sqlite",
        package = "System.Data.SQLite.Core",
        version = "1.0.113",
        net_lib = "lib/net46/System.Data.SQLite.dll",
        net_files = [
            "lib/net46/System.Data.SQLite.dll",
            "build/net46/x64/SQLite.Interop.dll",  # Native dependency
            "build/net46/x86/SQLite.Interop.dll",
        ],
    )

Running Executables
-------------------

**bazel run**: Runs the executable in a sandbox with all declared runtime dependencies.

**bazel test**: Runs test executables with the NUnit3 or xUnit test framework launcher.

**Direct execution**: You can also build the executable and run it directly:

.. code:: batch

    bazel build //path/to:MyApp.exe
    bazel-bin\path\to\MyApp.exe

However, direct execution may fail if runtime dependencies are not in the same directory.
Use ``bazel run`` for guaranteed correct runtime setup.

Debugging
---------

.NET Framework executables built by Bazel generate .pdb (program database) files for debugging.

To debug in Visual Studio:
1. Build with ``--compilation_mode=dbg`` (default)
2. Open the executable in Visual Studio debugger
3. Point the debugger to the source files in your workspace

Note: Release builds (``--compilation_mode=opt``) generate smaller assemblies but limited debugging info.
